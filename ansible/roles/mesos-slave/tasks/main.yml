---
# mesos-slave/tasks/main.yml

- name: Remove existing yum repositories
  tags: mesos-slave
  shell: rm -rf /etc/yum.repos.d/*.repo
  become: true

- name: Install scale.repo
  tags: mesos-slave
  copy: src=scale.repo dest=/etc/yum.repos.d/scale.repo
  become: true

- name: Update yum repo
  tags: mesos-slave
  command: yum clean all
  become: true

- name: Install docker-engine
  tags: mesos-slave
  yum: name=docker-engine-1.9.1
  become: true

- name: Install pip.conf
  tags: mesos-slave
  copy: src=pip.conf dest=/etc/pip.conf
  become: true

- name: Install pydistutils.cfg
  tags: mesos-slave
  copy: src=pydistutils.cfg dest=/root/.pydistutils.cfg
  become: true

- name: Install postgresql
  tags: mesos-slave
  yum: name=postgresql
  become: true

- name: Install gdal-python
  tags: mesos-slave
  yum: name=gdal-python
  become: true

- name: Install gcc
  tags: mesos-slave
  yum: name=gcc
  become: true

- name: Install python-devel
  tags: mesos-slave
  yum: name=python-devel
  become: true

- name: Install python-psycopg2
  tags: mesos-slave
  yum: name=python-psycopg2
  become: true

- name: Install postgresql-devel
  tags: mesos-slave
  yum: name=postgresql-devel
  become: true

- name: Install geos
  tags: mesos-slave
  yum: name=geos
  become: true

- name: Install subversion-libs
  tags: mesos-slave
  yum: name=subversion-libs
  become: true

- name: Install nfs-utils
  tags: mesos-slave
  yum: name=nfs-utils
  become: true

- name: Install python-pip
  tags: mesos-slave
  yum: name=python-pip
  become: true

- name: Install sudo
  tags: mesos-slave
  yum: name=sudo
  become: true

- name: Install unzip
  tags: mesos-slave
  yum: name=unzip
  become: true

- name: Install protobuf
  tags: mesos-slave
  yum: name=protobuf
  become: true

- name: Install rsync
  tags: mesos-slave
  yum: name=rsync
  become: true

- name: Install google apputils
  tags: mesos-slave
  pip: name="google-apputils"
  become: true

- name: Install protobuf bindings
  tags: mesos-slave
  pip: name="protobuf<3.0.0b1.post1"
  become: true

- name: Copy mesos
  tags: mesos-slave
  copy: src=mesos-0.24.1-0.2.35.centos701406.x86_64.rpm dest=/tmp/mesos-0.24.1-0.2.35.centos701406.x86_64.rpm

- name: Install mesos
  tags: mesos-slave
  yum: name=/tmp/mesos-0.24.1-0.2.35.centos701406.x86_64.rpm
  become: true

- name: Disable mesos master
  tags: mesos-slave
  service: name=mesos-master state=stopped enabled=false
  become: true

- name: Enable mesos slave
  tags: mesos-slave
  service: name=mesos-slave state=started enabled=true
  become: true

- name: Start rpcbind
  tags: mesos-slave
  service: name=rpcbind state=started enabled=true
  become: true

- name: Copy mesos python bindings
  tags: mesos-slave
  copy: src=mesos-0.24.1-py2.7-linux-x86_64.egg dest=/tmp/mesos-0.24.1-py2.7-linux-x86_64.egg

# easy_install plugin doesn't seem to work right with eggs
- name: Install mesos python bindings
  tags: mesos-slave
  command: easy_install /tmp/mesos-0.24.1-py2.7-linux-x86_64.egg
  become: true

- name: Check for node workdir
  tags: [mesos-slave, build-scale-only]
  stat: path='{{ node_work_dir }}'
  register: node_work_dir_stat

- name: Create node workdir
  tags: [mesos-slave, build-scale-only]
  file: path='{{ node_work_dir }}' state=directory mode=0777
  become: true
  when: node_work_dir_stat.stat.exists == False

- name: Create scale user
  tags: [mesos-slave, build-scale-only]
  user: name=scale groups=docker
  become: true

- name: Create scale dest dir
  tags: [mesos-slave, build-scale-only]
  file: path=/opt/scale owner=scale mode=0775 state=directory
  become: true

- name: Check for ssh keys
  tags: [mesos-slave, build-scale-only]
  stat: path=~/.ssh/id_rsa
  register: user_ssh_keys

- name: Get the username running the deploy
  tags: [mesos-slave, build-scale-only]
  local_action: command whoami
  register: username_on_host
  become: no
  
- name: Create ssh keys
  tags: [mesos-slave, build-scale-only]
  user: name={{ username_on_host.stdout }} generate_ssh_key=yes ssh_key_file=.ssh/id_rsa
  when: user_ssh_keys.stat.exists == False
  
- name: Add ssh keys
  tags: [mesos-slave, build-scale-only]
  authorized_key: user={{ username_on_host.stdout }} key={{ lookup('file', '~/.ssh/id_rsa.pub') }} state=present
  become: true

- name: Install scale
  tags: [mesos-slave, build-scale-only]
  synchronize: src=../scale dest=/opt delete=yes 

- name: Chown scale dir to scale user
  tags: [mesos-slave, build-scale-only]
  file: path=/opt/scale owner=scale mode=0777 state=directory recurse=yes
  become: true

- name: Install python dependencies
  tags: mesos-slave
  pip: requirements=/opt/scale/pip/prod_linux.txt
  become: true

#- name: Setup sudoers
#  tags: mesos-slave
#  copy: dest=/etc/sudoers.d/scale src=scale.sudoers
#  become: true

# Need to do this or anisble will complain that we're trying to change a normal file to a symlink
#- name: Remove existing local_settings
#  tags: mesos-slave
#  file: path=/opt/scale/scale/local_settings.py state=absent
#  become: true
#  become_user: scale

#- name: Setup local_settings
#  tags: mesos-slave
#  file: src=/etc/scale/local_settings.py dest=/opt/scale/scale/local_settings.py state=link
#  become: true

- name: Setup mesos zk
  tags: mesos-slave
  template: src=zk.j2 dest=/etc/mesos/zk
  become: true

- name: Setup mesos resources
  tags: mesos-slave
  template: src=resources.j2 dest=/etc/mesos-slave/resources
  become: true

- name: Setup mesos containerizers
  tags: mesos-slave
  copy: src=containerizers dest=/etc/mesos-slave/containerizers
  become: true

- name: Setup mesos slave config
  tags: mesos-slave
  template: src=mesos-slave.j2 dest=/etc/default/mesos-slave
  become: true
  notify:
    - restart mesos-slave
